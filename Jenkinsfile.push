pipeline {
    agent {
        label 'az-plug' 
    }
    
    environment {
        DISCORD_WEBHOOK = credentials('discord-webhook')
    }

    options {
        ansiColor('xterm')
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }

    stages {
        stage('üîß Setup Environment') {
            steps {
                node('az-plug') {
                    sh '''
                        which az || {
                            echo "Installing Azure CLI..."
                            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
                            echo "Azure CLI installed successfully"
                        }
                    '''
                }
            }
        }

        stage('üîç USE ') {
            steps {
                node('az-plug') {
                    step([$class: 'GitHubCommitStatusSetter',
                     statusResultSource: [$class: 'ConditionalStatusResultSource',
                     results: [[$class: 'AnyBuildResult', 
                               message: 'Pipeline Proceeded', 
                               state: 'PENDING']]]])
                    sh '''
                        which az || {
                            echo "Installing Azure CLI..."
                            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
                            echo "Azure CLI installed successfully"
                        }
                    '''
                    sh 'ls -la'
                    git url: 'https://github.com/voutuk/OLX_Dyplom_ADM', branch: 'main'
                    withCredentials([azureServicePrincipal('az-service-principal')]) {
                        sh 'az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID'
                        sh 'az acr build --registry gosellshiningswan --resource-group gosell-storage --image olx-client:latest --file ./OLX.Frontend/Dockerfile ./OLX.Frontend/'
                        sh 'az acr build --registry gosellshiningswan --resource-group gosell-storage --image olx-api:latest --file ./OLX.API/Dockerfile ./OLX.API/'
                    }
                }
            }
        }  
    }

    post {
        success {
            discordSend(
                description: "‚úÖ Build —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!",
                footer: "Jen / BublikDEV",
                link: env.BUILD_URL,
                result: "üü¢ SUCCESS",
                title: env.JOB_NAME,
                webhookURL: DISCORD_WEBHOOK
            )
            step([$class: 'GitHubCommitStatusSetter',
                         statusResultSource: [$class: 'ConditionalStatusResultSource',
                         results: [[$class: 'AnyBuildResult', 
                                   message: 'Deployed', 
                                   state: 'SUCCESS']]]])
        }
        failure {
            discordSend(
                description: "‚ùå Build –ø—Ä–æ–≤–∞–ª–∏–≤—Å—è!",
                footer: "Jen / BublikDEV",
                link: env.BUILD_URL,
                result: "üî¥ FAILURE",
                title: env.JOB_NAME,
                webhookURL: DISCORD_WEBHOOK
            )
            step([$class: 'GitHubCommitStatusSetter',
                         statusResultSource: [$class: 'ConditionalStatusResultSource',
                         results: [[$class: 'AnyBuildResult', 
                                   message: 'Failed', 
                                   state: 'FAILURE']]]])
        }
        unstable {
            discordSend(
                description: "‚ö†Ô∏è Build –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–∏–π!",
                footer: "Jen / BublikDEV",
                link: env.BUILD_URL,
                result: "üü° UNSTABLE",
                title: env.JOB_NAME,
                webhookURL: DISCORD_WEBHOOK
            )
            step([$class: 'GitHubCommitStatusSetter',
                         statusResultSource: [$class: 'ConditionalStatusResultSource',
                         results: [[$class: 'AnyBuildResult', 
                                   message: 'Unstable',
                                   state: 'FAILURE']]]]) 
        }
        always {
            cleanWs()
        }
    }
}